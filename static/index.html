<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Event Registration System</title>

    <!-- ✅ FullCalendar v5 CSS (WORKS WITHOUT BUILD TOOLS) -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.css?v=12345" rel="stylesheet" />

    <style>
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
            background: #faf5f7;
            margin: 0;
        }

        .container {
            max-width: 900px;
            margin: 40px auto;
            background: #ffffff;
            border-radius: 12px;
            padding: 32px 40px 40px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.06);
        }

        h1 {
            text-align: center;
            margin-top: 0;
            margin-bottom: 24px;
            color: #3b0a22;
        }

        h2 {
            margin-top: 24px;
            margin-bottom: 12px;
            color: #4d102b;
        }

        input, button, select, textarea {
            width: 100%;
            padding: 10px 12px;
            margin-top: 10px;
            border-radius: 6px;
            border: 1px solid #ddd;
            box-sizing: border-box;
            font-size: 14px;
        }

        textarea {
            min-height: 70px;
        }

        button {
            border: none;
            background: #800020;
            color: white;
            cursor: pointer;
            font-weight: 600;
            letter-spacing: 0.02em;
        }

        button:hover {
            background: #a01838;
        }

        .btn-secondary {
            background: #f3e5ec;
            color: #4d102b;
            border: 1px solid #d8b4ce;
        }

        .btn-secondary:hover {
            background: #e7d2e2;
        }

        .event-card {
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 12px 14px;
            margin-bottom: 10px;
            background: #fff8fb;
        }

        .event-card-title {
            font-weight: 600;
            color: #4d102b;
        }

        .event-location {
            font-style: italic;
            font-size: 13px;
            color: #555;
        }

        .top-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 999px;
            background: #fde2eb;
            color: #800020;
            font-size: 11px;
            font-weight: 600;
            margin-left: 6px;
        }

        .small-text {
            font-size: 13px;
            color: #555;
        }

        .section-card {
            margin-top: 16px;
            padding: 16px;
            border-radius: 10px;
            border: 1px solid #f0d7e2;
            background: #fff;
        }

        .error-text {
            color: #b00020;
            font-size: 14px;
            margin-top: 8px;
        }

        .success-text {
            color: #0f7b32;
            font-size: 14px;
            margin-top: 8px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 8px;
            margin-top: 8px;
            margin-bottom: 8px;
            border-bottom: 1px solid #f0d7e2;
        }

        .tab-btn {
            padding: 8px 14px;
            border-radius: 999px 999px 0 0;
            border: 1px solid transparent;
            background: #fde7f0;
            color: #800020;
            font-size: 14px;
            cursor: pointer;
        }

        .tab-btn.active {
            background: #800020;
            color: #fff;
            border-color: #800020;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .capacity-text {
            font-size: 13px;
            color: #444;
            margin-top: 4px;
        }

        .registration-row {
            margin-bottom: 6px;
        }

        .registration-row button {
            width: auto;
            padding: 4px 10px;
            font-size: 12px;
            margin-left: 6px;
        }

        /* Calendar style overrides */
        #calendar {
            margin-top: 10px;
        }

        .fc-scrollgrid {
            border: 1px solid #f0d7e2 !important;
        }

        .fc td, 
        .fc th {
            border-color: #f7dde9 !important;
        }

        .fc-toolbar-title {
            color: #4d102b;
        }

        .fc-button-primary {
            background-color: #800020 !important;
            border-color: #800020 !important;
        }

        .fc-daygrid-event {
            background-color: #f6d1e3 !important;
            border: 1px solid #e4a8c6 !important;
            color: #4d102b !important;
        }
    </style>
</head>
<body>

<div class="container">

    <h1>Event Registration System</h1>

    <!-- LOGIN SECTION -->
    <div id="auth-section">
        <h2 id="auth-title">Login</h2>

        <div id="login-form">
            <input type="email" id="login-email" placeholder="Email">
            <input type="password" id="login-password" placeholder="Password">
            <button onclick="login()">Login</button>
            <p class="small-text">
                Don’t have an account?
                <span class="link" onclick="showRegister()">Register</span>
            </p>
            <p id="auth-message" class="error-text"></p>
        </div>

        <div id="register-form" style="display:none;">
            <input type="text" id="register-name" placeholder="Your Name">
            <input type="email" id="register-email" placeholder="Your Email">
            <input type="password" id="register-password" placeholder="Password">
            <button onclick="registerUser()">Create Account</button>
            <p class="small-text">
                Already have an account?
                <span class="link" onclick="showLogin()">Back to login</span>
            </p>
            <p id="register-message" class="error-text"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-section" style="display:none;">
        <div class="top-bar">
            <div>
                <strong id="user-info"></strong>
                <span id="role-badge" class="badge"></span>
            </div>
            <button class="btn-secondary" onclick="logout()">Logout</button>
        </div>

        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" data-tab="events-tab">Events</button>
            <button class="tab-btn" data-tab="calendar-tab">Calendar</button>
            <button class="tab-btn" data-tab="registrations-tab">My Registrations</button>
        </div>

        <!-- EVENTS TAB -->
        <div id="events-tab" class="tab-content active">
            <div class="section-card">
                <h2>Available Events</h2>
                <div id="events-list"></div>
            </div>

            <div class="section-card">
                <h2>Register for an Event</h2>
                <select id="reg-event-select"></select>
                <input type="text" id="reg-name" disabled>
                <input type="email" id="reg-email" disabled>
                <textarea id="reg-notes" placeholder="Notes (optional)"></textarea>
                <button onclick="registerForEvent()">Register</button>
                <p id="reg-message"></p>
            </div>

            <!-- ADMIN -->
            <div class="section-card" id="admin-section" style="display:none;">
                <h2>Admin: Manage Events</h2>

                <h3>Create New Event</h3>
                <input type="text" id="admin-event-name" placeholder="Event Name">
                <textarea id="admin-event-description" placeholder="Description"></textarea>
                <input type="datetime-local" id="admin-event-date">
                <input type="text" id="admin-event-location" placeholder="Location">
                <input type="number" id="admin-event-capacity" placeholder="Max Capacity (optional)" min="1">
                <button onclick="adminCreateEvent()">Create Event</button>
                <p id="admin-create-message"></p>

                <h3>Existing Events</h3>
                <div id="admin-events-list"></div>
            </div>
        </div>

        <!-- CALENDAR TAB -->
        <div id="calendar-tab" class="tab-content">
            <div class="section-card">
                <h2>My Event Calendar</h2>
                <p class="small-text" id="calendar-hint"></p>
                <div id="calendar"></div>
            </div>
        </div>

        <!-- REGISTRATIONS TAB -->
        <div id="registrations-tab" class="tab-content">
            <div class="section-card">
                <h2>My Registrations</h2>
                <button class="btn-secondary" onclick="loadMyRegistrations()">Refresh</button>
                <div id="my-registrations" class="small-text" style="margin-top:10px;"></div>
            </div>
        </div>

    </div>

</div>

<!-- ✅ FullCalendar v5 JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.5/main.min.js?v=12345"></script>

<script>
/* CONFIG */

const API = (
    window.location.hostname.includes("127.0.0.1") ||
    window.location.hostname.includes("localhost")
)
    ? "http://127.0.0.1:8000"
    : "https://eventregistration-api-a6dmevh3bbafc2c5.westeurope-01.azurewebsites.net";

let authToken = null;
let currentUser = null;
let calendar = null;

/* HELPERS */

function setMessage(id, text, type) {
    const el = document.getElementById(id);
    el.textContent = text || "";
    el.className = type === "error" ? "error-text" : (type === "success" ? "success-text" : "");
}

function showLogin() {
    document.getElementById("auth-section").style.display = "block";
    document.getElementById("dashboard-section").style.display = "none";
    document.getElementById("login-form").style.display = "block";
    document.getElementById("register-form").style.display = "none";
}

function showRegister() {
    document.getElementById("auth-section").style.display = "block";
    document.getElementById("dashboard-section").style.display = "none";
    document.getElementById("login-form").style.display = "none";
    document.getElementById("register-form").style.display = "block";
}

/* TABS */

function activateTab(tabId) {
    document.querySelectorAll(".tab-btn").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.tab === tabId);
    });
    document.querySelectorAll(".tab-content").forEach(div => {
        div.classList.toggle("active", div.id === tabId);
    });

    if (tabId === "calendar-tab") loadCalendarEvents();
    if (tabId === "registrations-tab") loadMyRegistrations();
}

document.addEventListener("click", (e) => {
    if (e.target.classList.contains("tab-btn")) {
        activateTab(e.target.dataset.tab);
    }
});

/* AUTH */

async function login() {
    const email = document.getElementById("login-email").value.trim();
    const password = document.getElementById("login-password").value;

    const body = new URLSearchParams();
    body.append("username", email);
    body.append("password", password);

    const res = await fetch(`${API}/auth/login`, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body
    });

    const data = await res.json();
    if (!res.ok) {
        setMessage("auth-message", data.detail || "Login failed", "error");
        return;
    }

    authToken = data.access_token;
    localStorage.setItem("token", authToken);

    await fetchCurrentUser();
    afterLogin();
}

async function registerUser() {
    const name = document.getElementById("register-name").value.trim();
    const email = document.getElementById("register-email").value.trim();
    const password = document.getElementById("register-password").value;

    const res = await fetch(`${API}/auth/register`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name, email, password })
    });

    const data = await res.json();
    if (!res.ok) {
        setMessage("register-message", data.detail || "Registration failed", "error");
        return;
    }

    setMessage("register-message", "Account created! Please log in.", "success");
    showLogin();
    document.getElementById("login-email").value = email;
}

async function fetchCurrentUser() {
    const res = await fetch(`${API}/auth/me`, {
        headers: { "Authorization": `Bearer ${authToken}` }
    });
    currentUser = await res.json();
}

function afterLogin() {
    document.getElementById("auth-section").style.display = "none";
    document.getElementById("dashboard-section").style.display = "block";

    document.getElementById("user-info").textContent = currentUser.email;
    document.getElementById("role-badge").textContent = currentUser.role;

    document.getElementById("reg-name").value = currentUser.name;
    document.getElementById("reg-email").value = currentUser.email;

    document.getElementById("admin-section").style.display =
        currentUser.role === "admin" ? "block" : "none";

    loadEvents();
    activateTab("events-tab");
}

function logout() {
    authToken = null;
    currentUser = null;
    localStorage.clear();
    showLogin();
}

/* EVENTS */

async function loadEvents() {
    const res = await fetch(`${API}/events/`);
    const events = await res.json();

    const list = document.getElementById("events-list");
    const select = document.getElementById("reg-event-select");
    const adminList = document.getElementById("admin-events-list");

    list.innerHTML = "";
    select.innerHTML = "";
    adminList.innerHTML = "";

    events.forEach(ev => {
        const current = ev.current_count ?? 0;

        const spotsText = ev.max_capacity == null
            ? "Unlimited spots"
            : `${ev.max_capacity - current} spots left`;

        const card = document.createElement("div");
        card.className = "event-card";
        card.innerHTML = `
            <div class="event-card-title">${ev.name}</div>
            <div>${ev.description || ""}</div>
            <div class="event-location">
                ${ev.location || ""}<br>
                ${ev.date ? new Date(ev.date).toLocaleString() : ""}
            </div>
            <div class="capacity-text">${spotsText}</div>
        `;
        list.appendChild(card);

        const opt = document.createElement("option");
        opt.value = ev.id;
        opt.textContent = `${ev.name} (${spotsText})`;
        select.appendChild(opt);

        if (currentUser.role === "admin") {
            const adminCard = document.createElement("div");
            adminCard.className = "event-card";
            adminCard.innerHTML = `
                <div class="event-card-title">${ev.name}</div>
                <div>${ev.description || ""}</div>
                <div class="event-location">${ev.location}<br>${new Date(ev.date).toLocaleString()}</div>
                <div class="capacity-text">Capacity: ${ev.max_capacity ?? "unlimited"} – Registered: ${current}</div>
                <button class="btn-secondary" onclick="adminDeleteEvent(${ev.id})">Delete</button>
            `;
            adminList.appendChild(adminCard);
        }
    });
}

/* REGISTER FOR EVENT */

async function registerForEvent() {
    const event_id = parseInt(document.getElementById("reg-event-select").value);
    const notes = document.getElementById("reg-notes").value;

    const res = await fetch(`${API}/registrations/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${authToken}`
        },
        body: JSON.stringify({
            event_id,
            participant_name: currentUser.name,
            participant_email: currentUser.email,
            notes
        })
    });

    if (res.ok) {
        setMessage("reg-message", "Registered successfully!", "success");
        loadEvents();
        loadMyRegistrations();
        loadCalendarEvents();
    }
}

/* FULLCALENDAR */

function ensureCalendar() {
    if (calendar) return; // already created

    const calendarEl = document.getElementById("calendar");
    calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: "dayGridMonth",
        height: 600,
        headerToolbar: {
            left: "prev,next today",
            center: "title",
            right: ""
        }
    });

    calendar.render();
}

async function loadCalendarEvents() {
    ensureCalendar();

    let url = currentUser.role === "admin"
        ? `${API}/registrations/`
        : `${API}/registrations/?email=${currentUser.email}`;

    const res = await fetch(url);
    const regs = await res.json();

    calendar.removeAllEvents();

    const events = regs.map(r => ({
        title: r.event_name,
        start: r.event_date
    }));

    calendar.addEventSource(events);
}

/* REGISTRATIONS */

async function loadMyRegistrations() {
    const res = await fetch(`${API}/registrations/?email=${currentUser.email}`);
    const regs = await res.json();

    const box = document.getElementById("my-registrations");
    box.innerHTML = "";

    if (regs.length === 0) {
        box.textContent = "You have no registrations.";
        return;
    }

    regs.forEach(r => {
        const row = document.createElement("div");
        row.className = "registration-row";
        row.innerHTML = `
            • ${r.event_name} – ${new Date(r.event_date).toLocaleString()}
        `;
        const btn = document.createElement("button");
        btn.className = "btn-secondary";
        btn.textContent = "Unregister";
        btn.onclick = () => unregister(r.id);
        row.appendChild(btn);
        box.appendChild(row);
    });
}

async function unregister(id) {
    await fetch(`${API}/registrations/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${authToken}` }
    });

    loadMyRegistrations();
    loadEvents();
    loadCalendarEvents();
}

/* ADMIN */

async function adminCreateEvent() {
    const name = document.getElementById("admin-event-name").value;
    const description = document.getElementById("admin-event-description").value;
    const date = document.getElementById("admin-event-date").value;
    const location = document.getElementById("admin-event-location").value;
    const capacity = document.getElementById("admin-event-capacity").value;

    const res = await fetch(`${API}/events/`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${authToken}`
        },
        body: JSON.stringify({
            name,
            description,
            date: new Date(date).toISOString(),
            location,
            max_capacity: capacity ? parseInt(capacity) : null
        })
    });

    if (res.ok) {
        setMessage("admin-create-message", "Event created!", "success");
        loadEvents();
        loadCalendarEvents();
    }
}

async function adminDeleteEvent(id) {
    await fetch(`${API}/events/${id}`, {
        method: "DELETE",
        headers: { "Authorization": `Bearer ${authToken}` }
    });

    loadEvents();
    loadCalendarEvents();
}

/* INIT */

(async function init() {
    const token = localStorage.getItem("token");
    if (!token) return showLogin();

    authToken = token;

    try {
        await fetchCurrentUser();
        afterLogin();
    } catch {
        showLogin();
    }
})();
</script>

</body>
</html>
